<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>WebSocket æµ‹è¯• - å°æ™ºESP32</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; background: #f5f5f5; }
        h2 { color: #333; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        input, button { padding: 10px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; }
        input { width: 400px; }
        button { cursor: pointer; background: #007bff; color: white; border: none; }
        button:hover { background: #0056b3; }
        #log { background: #1e1e1e; color: #0f0; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace; border-radius: 5px; font-size: 13px; }
        .card { background: white; padding: 20px; margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h2>ğŸ¤– å°æ™º ESP32 WebSocket æµ‹è¯•</h2>
    
    <div class="card">
        <h3>ğŸ”Œ è¿æ¥è®¾ç½®</h3>
        <label>WebSocket åœ°å€ï¼š</label><br>
        <input type="text" id="wsUrl" value="ws://192.168.0.113:8091/ws/xiaozhi/v1/">
        <br><br>
        <label>è®¾å¤‡ IDï¼ˆå¿…å¡«ï¼‰ï¼š</label><br>
        <input type="text" id="deviceId" value="test-device-001" style="width:200px;">
        <br><br>
        <button onclick="connect()">ğŸ”Œ è¿æ¥</button>
        <button onclick="disconnect()" style="background:#dc3545;">âŒ æ–­å¼€</button>
        <div id="statusDiv" class="status disconnected">çŠ¶æ€ï¼šæœªè¿æ¥</div>
    </div>
    
    <div class="card">
        <h3>ğŸ“¤ å‘é€æ¶ˆæ¯</h3>
        <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹">
        <button onclick="sendMessage()">ğŸ“¤ å‘é€</button>
        <button onclick="sendHello()" style="background:#28a745;">ğŸ‘‹ å‘é€ Hello</button>
    </div>
    
    <div class="card">
        <h3>ğŸ“‹ é€šä¿¡æ—¥å¿—</h3>
        <div id="log"></div>
        <button onclick="clearLog()" style="background:#6c757d; margin-top:10px;">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let ws;
        const log = document.getElementById('log');
        const statusDiv = document.getElementById('statusDiv');
        
        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const colors = { info: '#0f0', send: '#ffff00', receive: '#00ffff', error: '#ff4444' };
            log.innerHTML += `<div style="color:${colors[type]}">[${time}] ${msg}</div>`;
            log.scrollTop = log.scrollHeight;
        }
        
        function updateStatus(connected) {
            statusDiv.className = 'status ' + (connected ? 'connected' : 'disconnected');
            statusDiv.textContent = 'çŠ¶æ€ï¼š' + (connected ? 'å·²è¿æ¥ âœ…' : 'æœªè¿æ¥ âŒ');
        }
        
        function connect() {
            const baseUrl = document.getElementById('wsUrl').value;
            const deviceId = document.getElementById('deviceId').value;
            
            if (!deviceId) {
                addLog('âŒ è¯·è¾“å…¥è®¾å¤‡ ID', 'error');
                return;
            }
            
            // æ·»åŠ  device-id å‚æ•°åˆ° URL
            const separator = baseUrl.includes('?') ? '&' : '?';
            const url = baseUrl + separator + 'device-id=' + deviceId;
            addLog('æ­£åœ¨è¿æ¥: ' + url);
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = () => {
                    addLog('âœ… WebSocket è¿æ¥æˆåŠŸï¼');
                    updateStatus(true);
                    // è‡ªåŠ¨å‘é€ Hello æ¡æ‰‹æ¶ˆæ¯
                    setTimeout(() => {
                        sendHello();
                    }, 100);
                };
                
                ws.onmessage = (event) => {
                    addLog('ğŸ“© æ”¶åˆ°æ¶ˆæ¯: ' + event.data, 'receive');
                };
                
                ws.onerror = (error) => {
                    addLog('âŒ è¿æ¥å‘ç”Ÿé”™è¯¯', 'error');
                    updateStatus(false);
                };
                
                ws.onclose = (event) => {
                    addLog('ğŸ”Œ è¿æ¥å·²å…³é—­ (code: ' + event.code + ', reason: ' + event.reason + ')');
                    updateStatus(false);
                };
            } catch (e) {
                addLog('âŒ é”™è¯¯: ' + e.message, 'error');
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                addLog('ä¸»åŠ¨æ–­å¼€è¿æ¥');
            }
        }
        
        function sendMessage() {
            const msg = document.getElementById('message').value;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(msg);
                addLog('ğŸ“¤ å‘é€: ' + msg, 'send');
            } else {
                addLog('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
            }
        }
        
        function sendHello() {
            const hello = JSON.stringify({
                type: "hello",
                version: 1,
                transport: "websocket",
                audio_params: {
                    format: "opus",
                    sample_rate: 16000,
                    channels: 1
                }
            });
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(hello);
                addLog('ğŸ“¤ å‘é€ Hello æ¡æ‰‹: ' + hello, 'send');
            } else {
                addLog('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
            }
        }
        
        function clearLog() {
            log.innerHTML = '';
            addLog('æ—¥å¿—å·²æ¸…ç©º');
        }
        
        // é¡µé¢åŠ è½½æç¤º
        addLog('ğŸš€ WebSocket æµ‹è¯•å·¥å…·å·²å°±ç»ª');
        addLog('ğŸ’¡ ç‚¹å‡»"è¿æ¥"æŒ‰é’®å¼€å§‹æµ‹è¯•');
    </script>
</body>
</html>

